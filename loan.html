<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Jorge Chavarriaga">
    <link rel="shortcut icon" href="assets//images/favicon-jch-32x32.png">
    <title>Loan Calculator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link id="theme-style" rel="stylesheet" href="assets/css/form.css">
</head>

<body>
    <div class="container mt-5">
        <h1 style="text-align: center;">Loan Calculator</h1>
        <form id="loan_calc" action="https://7949-69-158-28-151.ngrok-free.app/cgi-bin/loan_calc1.py" method="post"
            enctype="multipart/form-data">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <h3 style="text-align: center;">Loan Amount</h3>
                    <label for="loan_amount_input" class="form-label">Loan Amount:</label>
                    <input type="text" class="form-control" id="loan_amount_input" name="loan_amount" required>
                </div>
                <div class="col-md-6 mb-4">
                    <h3 style="text-align: center;">Annual Interest Rate (%)</h3>
                    <label for="annual_interest_rate_range" class="form-label">Annual Interest Rate:</label>
                    <input type="range" class="form-range" min="0" max="20" step="0.01" id="annual_interest_rate_range"
                        name="annual_interest_rate_range" value="0">
                    <span id="rangeValue_interest">0%</span>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <h3 style="text-align: center;">Loan Period (Years)</h3>
                    <label for="loan_period_years_range" class="form-label">Years:</label>
                    <input type="range" class="form-range" min="1" max="30" step="1" id="loan_period_years_range"
                        name="loan_period_years_range" value="0">
                    <span id="rangeLoan_Period_interest">0</span>
                </div>
                <div class="col-md-6 mb-4">
                    <h3 style="text-align: center;">Loan Start Date</h3>
                    <label for="start_date_input" class="form-label">Date:</label>
                    <input type="date" class="form-control" id="start_date_input" name="start_date" required>
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="calculateButton">Calculate</button>
        </form>
        <div id="table-container"></div> <!-- Aquí se mostrará la tabla -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Función para dar formato de moneda a un valor con decimales
        function formatCurrencyWithDecimals(value) {
            return '$ ' + parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Función para realizar la solicitud al servidor y mostrar la tabla
        function calculateLoan() {
            const loanAmountInput = document.getElementById('loan_amount_input');
            const annualInterestRateRange = document.getElementById('annual_interest_rate_range');
            const rangeValueInterest = document.getElementById('rangeValue_interest');
            const loanPeriodSelect = document.getElementById('loan_period_years_range');
            const startDateInput = document.getElementById('start_date_input');
            const loanPeriodMonths = parseInt(loanPeriodSelect.value) * 12;

            // Obtener los valores del formulario
            const loanAmount = parseFloat(loanAmountInput.value.replace(/[^0-9.]/g, '')) || 0;
            const annualInterestRate = parseFloat(annualInterestRateRange.value) || 0;
            const loanPeriodYears = parseFloat(loanPeriodSelect.value) || 0;
            const startDate = startDateInput.value;

            // Realizar una solicitud al servidor (script de Python)
            fetch('https://7949-69-158-28-151.ngrok-free.app/calculate_loan', {
                method: 'POST',
                body: new URLSearchParams({
                    'loan_amount': loanAmount,
                    'annual_interest_rate_range': annualInterestRate,
                    'loan_period_years_range': loanPeriodYears,
                    'start_date': startDate
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    // Aquí procesa los datos JSON y dibuja la tabla en el HTML
                    drawTable(data);
                })
                .catch(error => {
                    console.error('Error al obtener los datos:', error);
                });
        }

        // Función para dibujar la tabla con los datos recibidos
        function drawTable(data) {
            const tableContainer = document.getElementById('table-container');
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // Crear la cabecera de la tabla
            const headerRow = document.createElement('tr');
            data.header.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Crear las filas de datos
            data.rows.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach(cellData => {
                    const cell = document.createElement('td');
                    cell.textContent = cellData;
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });

            // Agregar la cabecera y las filas al cuerpo de la tabla
            table.appendChild(thead);
            table.appendChild(tbody);

            // Agregar la tabla al contenedor en el HTML
            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }

        // Asignar la función al botón "Calculate"
        document.getElementById('calculateButton').addEventListener('click', calculateLoan);

        // Sincronizar el valor del rango con el elemento HTML
        document.getElementById('annual_interest_rate_range').addEventListener('input', function () {
            const annualInterestRate = parseFloat(this.value) || 0;
            document.getElementById('rangeValue_interest').textContent = annualInterestRate.toFixed(2) + '%';
        });
        document.getElementById('loan_period_years_range').addEventListener('input', function () {
            const loanPeriodSelect = parseFloat(this.value) || 0;
            document.getElementById('rangeLoan_Period_interest').textContent = loanPeriodSelect;
        });
    </script>
</body>

</html>